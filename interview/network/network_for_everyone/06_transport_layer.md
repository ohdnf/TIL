# 전송 계층: 신뢰할 수 있는 데이터 전송하기



## 전송 계층의 역할

OSI의 3계층(물리 계층, 데이터 링크 계층, 네트워크 계층)만 있으면 목적지에 데이터를 보낼 수 있다. 하지만 데이터가 손상되거나 유실되면 이들 계층에선 처리할 수가 없다.

전송 계층은 **목적지에 신뢰할 수  있는 데이터를 전달**하기 위해 필요하다. 전송 계층의 역할은 다음과 같다.

- 오류가 발생하면 데이터를 재전송하도록 요청
- 전송된 데이터의 목적지가 어떤 애플리케이션인지 식별



### 연결형 통신

- 신뢰할 수 있고 정확한 데이터를 전달하는 통신
- _상대편과 확인해 가면서_ 통신
- TCP



### 비연결형 통신

- 효율적으로 데이터를 전달하는 통신
- _상대편을 확인하지 않고_ 일방적으로 데이터를 전송
- 동영상 등 빠른 전송이 필요한 데이터를 보낼 때
- UDP



## TCP의 구조

### TCP 헤더

TCP로 전송할 때 데이터에 붙이는 헤더를 TCP 헤더라고 하고, TCP 헤더가 붙은 데이터를 **세그먼트(segment)**라고 한다.

```
세그먼트(segment) = TCP 헤더 + 데이터
```

```
TCP 헤더 = 출발지 포트 번호(16비트) + 목적지 포트 번호(16비트) + 일련번호(32비트) + 확인 응답 번호(32비트) + 헤더 길이(4비트) + 예약 영역(6비트) + 코드 비트(6비트) + 윈도우 크기(16비트) + 체크섬(16비트) + 긴급 포인터(16비트) + 옵션
```



### 3-way handshake

데이터를 전송하려면 **연결(connection)**이라는 **가상의 독점 통신로**를 확보한 후 가능하다. 데이터를 보내기 전에 연결을 확립하기 위해 패킷 요청을 세 번 교환해 세션을 수립하는 것을 **3-way handshake**라고 한다. 이를 위해 **코드 비트의 SYN(연결 요청) 비트와 ACK(확인 응답) 비트가 필요**하다.

<img src="https://t1.daumcdn.net/cfile/tistory/9910A8345BB0B75F2A" alt="3-way handshake" style="zoom: 80%" />

#### 연결 확립 요청

통신을 하려면 Server에게 허가를 받아야 하므로, 먼저 Client에서 Server로 연결 확립 허가를 받기 위한 요청(SYN)을 보낸다.

| URG  | ACK  | PSH  | RST  | SYN  | FIN  |
| :--: | :--: | :--: | :--: | :--: | :--: |
|  0   |  0   |  0   |  0   |  1   |  0   |

#### 연결 확립 응답 + 연결 확립 요청

Server는 Client가 보낸 요청을 받은 후에 허가한다는 응답을 회신하기 위해 연결 확립 응답(ACK)을 보낸다. 동시에 Server도 Client에게 데이터 전송 허가를 받기 위해 연결 확립 요청(SYN)을 보낸다.

| URG  | ACK  | PSH  | RST  | SYN  | FIN  |
| :--: | :--: | :--: | :--: | :--: | :--: |
|  0   |  1   |  0   |  0   |  1   |  0   |

#### 연결 확립 응답

Server의 요청을 받은 Client는 Server로 허가한다는 응답으로 연결 확립 응답(ACK)을 보낸다.

| URG  | ACK  | PSH  | RST  | SYN  | FIN  |
| :--: | :--: | :--: | :--: | :--: | :--: |
|  0   |  1   |  0   |  0   |  0   |  0   |



### 4-way handshake

데이터 전송이 끝난 후에는 연결을 종료하기 위한 요청을 교환을 하는 과정을 말한다.

#### 연결 종료 요청

Client에서 Server로 연결 종료 요청(FIN)을 보낸다.

| URG  | ACK  | PSH  | RST  | SYN  | FIN  |
| :--: | :--: | :--: | :--: | :--: | :--: |
|  0   |  0   |  0   |  0   |  0   |  1   |

#### 연결 종료 응답

Server에서 Client로 연결 종료 응답(ACK)을 반환한다.

| URG  | ACK  | PSH  | RST  | SYN  | FIN  |
| :--: | :--: | :--: | :--: | :--: | :--: |
|  0   |  1   |  0   |  0   |  0   |  0   |

#### 연결 종료 요청

Server에서도 Client로 연결 종료 요청(FIN)을 보낸다.

| URG  | ACK  | PSH  | RST  | SYN  | FIN  |
| :--: | :--: | :--: | :--: | :--: | :--: |
|  0   |  0   |  0   |  0   |  0   |  1   |

#### 연결 종료 응답

Client에서 Server로 연결 종료 응답(ACK)을 반환한다.

| URG  | ACK  | PSH  | RST  | SYN  | FIN  |
| :--: | :--: | :--: | :--: | :--: | :--: |
|  0   |  1   |  0   |  0   |  0   |  0   |



## 일련번호와 확인 응답 번호의 구조

3-way handshake로 연결 수립이 이루어지면 TCP 헤더의 **일련번호**와 **확인 응답 번호**가 결정된다. 이는 실제 데이터를 보내거나 상대방이 받을 때 사용된다.

### 일련번호

전송된 데이터에 일련번호를 부여해 송신 측에서 수신 측에 '이 데이터가 **몇 번째 데이터**인지' 알려 주는 역할을 한다.

### 확인 응답 번호

수신 측이 **몇 번째 데이터**를 수신했는지 송신 측에 알려주는 역할을 한다. 그래서 이 번호는 다음 번호의 데이터를 요청하는 데도 사용된다. 예를 들어 10번 데이터를 수신하면 11번 데이터를 송신 측에 요청한다. 이것을 **확인 응답**이라고 한다.



아래 예시는 일련번호 `3001`와 확인 응답 번호 `4001`이 결정된 상태이다.

<img src="https://mblogthumb-phinf.pstatic.net/MjAyMDAyMjRfMTM0/MDAxNTgyNTA1MjA5MDA1.EgnmuivcoZNllWbvaWMwAazxrh1hXDibh1NSnmawW9gg.nyyzG3U5pI4GGRYSXLDfV7nUIYuuvIREvuyHHCZ6fk0g.JPEG.devks0228/IMG_0478.jpg?type=w800" alt="TCP sequence & acknoledgement numbers" style="zoom: 80%" />

#### 재전송 제어

데이터가 손상되거나 유실된 경우 일정 시간 동안 대기한 후 재전송하는 것



### 윈도우 크기

- **세그먼트(데이터)** 하나를 보낼 때마다 확인 응답을 반환하면 효율이 높지 않다.
- 세그먼트를 **최대한 연속으로 보내고** 확인 응답을 하면 효율이 높아진다.
- 수신 측에서 세그먼트를 일시적으로 보관하는 장소를 **버퍼(buffer)**라고 한다. 버퍼가 클수록 확인 응답을 일일이 하지 않고 연속해서 송수신할 수 있는 세그먼트의 양이 많아진다.
- 버퍼의 한계 크기보다 세그먼트가 더 많이 들어오는 것을 **오버플로(overflow)**라고 한다.
- TCP 헤더의 **윈도우 크기(window size)**는 버퍼의 한계 크기를 나타낸다.
- 윈도우 크기의 초깃값은 3-way handshake를 할 때 판단한다.



## 포트 번호의 구조

### 포트 번호

전송된 데이터의 목적지가 어떤 애플리케이션인지 구분하기 위해 사용하는 TCP 헤더의 정보

- 포트 번호는 0번부터 65535번까지

- 0번부터 1023번 포트는 **잘 알려진 포트(well-known ports)**라고 하며 주요 프로토콜이 사용하도록 예약되어 있다. 일반적으로 서버 측 애플리케이션에서 사용한다.

  | 애플리케이션 | 포트 번호 |
  | ------------ | --------- |
  | SSH          | 22        |
  | SMTP         | 25        |
  | DNS          | 53        |
  | HTTP         | 80        |
  | POP3         | 110       |
  | HTTPS        | 443       |

- 1024번 포트는 예약되어 있지만 사용하지 않는다

- 1025번 이상은 **랜덤 포트**로, 클라이언트 측의 송신 포트로 사용된다.



## UDP의 구조

TCP와 달리 비연결 통신이라 스트리밍 방식으로 전송하는 동영상 서비스와 같은 곳에 사용되는 통신 방식



### UDP 헤더

```
UDP 데이터그램 = UDP 헤더 + 데이터
```

```
UDP 헤더 = 출발지 포트 번호(16비트) + 목적지 포트 번호(16비트) + 길이(16비트) + 체크섬(16비트)
```



#### 브로드캐스트

UDP를 사용해 랜에 있는 컴퓨터나 네트워크 장비에 데이터를 일괄로 보내는 것. TCP는 확인 응답이 필요하기 때문에 브로드캐스트와 같이 불특정 다수에게 보내는 통신에 적합하지 않다.